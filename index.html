<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>АПБ Судейская Панель</title>
    
    <!-- PWA & Mobile Optimization -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    
    <!-- Ссылка на манифест -->
    <link rel="manifest" href="manifest.json">
     <!-- Фавиконы -->
    <!-- SVG иконка (основная для современных браузеров) -->
    <link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
    <!-- Запасной вариант (PNG) -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72.png">
    <!-- Иконка для iOS -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">

    <!---->
    <script type="module">
    import { loginWithKey, updateJudgeProfile, saveEvaluation } from './assets/firebase-db.js';
    
    // Делаем функции доступными для React-компонентов
    window.api = { loginWithKey, updateJudgeProfile, saveEvaluation };

    // Генерируем ID устройства при первом запуске
    let deviceId = localStorage.getItem('app_device_id');
    if (!deviceId) {
        deviceId = 'dev_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('app_device_id', deviceId);
    }
    window.deviceId = deviceId; // Сохраняем в глобальную область для использования в React
    </script>
    <!---->

    
    <style>
        body {
            background-color: #F8F8F8;
            margin: 0;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
        }
        * {
            font-family: 'Inter', sans-serif !important;
            -webkit-font-smoothing: antialiased;
        }
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined' !important;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes zoom-blur-out {
            0% { transform: scale(1); filter: blur(0px); opacity: 1; }
            100% { transform: scale(1.5); filter: blur(20px); opacity: 0; }
        }
        .loader-ring {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(0,0,0,0.05);
            border-top: 2px solid #000;
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }
        .preloader-exit {
            animation: zoom-blur-out 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
        }
        @keyframes card-appear {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-animate {
            animation: card-appear 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        video::-webkit-media-controls {
            display:none !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Регистрация Service Worker для PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed', err));
            });
        }

        // --- Прелоадер ---
        const Preloader = ({ onComplete }) => {
            const [isExiting, setIsExiting] = useState(false);
            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsExiting(true);
                    setTimeout(onComplete, 800); 
                }, 2500);
                return () => clearTimeout(timer);
            }, [onComplete]);

            return (
                <div className={`fixed inset-0 z-[9999] bg-white flex flex-col items-center justify-center ${isExiting ? 'preloader-exit' : ''}`}>
                    <div className="mb-8 text-black">
                        <svg width="120" height="120" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg">
  <rect fill="#3171af" width="96" height="96" rx="9.24" ry="9.24"/>
  
  <g fill="#ffffff">
    <path d="M33.12,78.03h-3.23l-1.28-2.88h-5.88l-1.21,2.88h-3.15l5.73-12.67h3.14l5.89,12.67Zm-5.47-5.01l-2.03-4.7-1.99,4.7h4.01Z"/>
    <path d="M34.8,65.36h11.7v12.67h-2.97v-10.55h-5.76v10.55h-2.97v-12.67Z"/>
    <path d="M49.91,65.36h10.99v2.13h-8.02v2.94h3.97c1.1,0,2.01,.12,2.73,.35,.72,.23,1.34,.66,1.85,1.28s.77,1.35,.77,2.19-.26,1.59-.77,2.2c-.52,.61-1.1,1.03-1.76,1.25-.66,.22-1.6,.34-2.81,.34h-6.94v-12.67Zm2.97,10.55h2.89c.92,0,1.57-.04,1.95-.12,.37-.08,.7-.26,.98-.53,.28-.28,.42-.62,.42-1.02,0-.59-.24-1.02-.73-1.28-.48-.27-1.31-.4-2.48-.4h-3.02v3.35Z"/>
  </g>

  <path fill="#ffffff" d="M81.8,13.1V82.9H14.2V13.1H81.8m3.9-4.03H10.3V86.92H85.7V9.08h0Z"/>
</svg>

                    </div>
                    <div className="loader-ring"></div>
                    <p className="mt-6 text-[10px] font-medium uppercase tracking-[0.3em] text-black opacity-40">АПБ судейская панель</p>
                </div>
            );
        };

        const Icon = ({ name, className = "", size = 20 }) => (
            <span className={`material-symbols-outlined ${className}`} style={{ fontSize: size }}>
                {name}
            </span>
        );

        function App() {
            const [loading, setLoading] = useState(true);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authStep, setAuthStep] = useState(1); 
            const [tempJudgeName, setTempJudgeName] = useState('');
            const [selectedCity, setSelectedCity] = useState('Москва');
            const [isCityOpen, setIsCityOpen] = useState(false);
            const [accessKey, setAccessKey] = useState('');
            const [authError, setAuthError] = useState('');

            const [judgeName, setJudgeName] = useState('');
            const [eventCity, setEventCity] = useState('');
            const [discipline, setDiscipline] = useState('Разметка');
            const [isDisciplineOpen, setIsDisciplineOpen] = useState(false);
            
            const [allData, setAllData] = useState({});
            const [submittedDisciplines, setSubmittedDisciplines] = useState([]);
            const [history, setHistory] = useState([]);
            
            const [openSelect, setOpenSelect] = useState({ id: null, type: null });
            const [fullscreenNote, setFullscreenNote] = useState(null); 
            const [toast, setToast] = useState(null);
            const [isRecording, setIsRecording] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);

            const [editJudgeName, setEditJudgeName] = useState('');
            const [editAccessKey, setEditAccessKey] = useState('');

            const [activeCamera, setActiveCamera] = useState(null);
            const [facingMode, setFacingMode] = useState('environment');
            const [stream, setStream] = useState(null);
            const videoRef = useRef(null);

            const cities = ['Москва', 'Пермь', 'Екатеринбург', 'Санкт-Петербург','Ростов-на-Дону'];
            const disciplines = [
    'Разметка', 'Смешка канекалона', 'Рисунок из брейдов', 'Вплетение комплекта кос',
    'Боксерские косы', 'Водопад', 'Брейды в хвост', 'Цветной ряд',
    'Наращивание на микро-косы', 'Каркасные прически', 'Термозамещение', 'Точечные косы',
    'Брейды без материала', 'Брейды с материалом', 'Микс-прически', 'Технический комплект',
    'Натуральные дреды', 'Подплетение нат. дредов', 'Творческие номинации', 'Секретная номинация',
    'Изделие из канекалона', 'Креативная причёска', 'Творческие боксерские косы', 'Творческий водопад',
    'Творческие брейды в хвост', 'Творческий комплект', 'Женский образ', 'Мужской образ',
    'Детский образ', 'Командная работа'
];
            const participantNumbers = Array.from({ length: 100 }, (_, i) => i.toString().padStart(2, '0'));

            useEffect(() => {
                const saved = localStorage.getItem('judging_app_v5_data');
                const savedSubmitted = localStorage.getItem('judging_app_v5_submitted');
                const savedHistory = localStorage.getItem('judging_app_v5_history');
                const savedProfile = localStorage.getItem('judging_app_v5_profile');

                if (saved) setAllData(JSON.parse(saved));
                if (savedSubmitted) setSubmittedDisciplines(JSON.parse(savedSubmitted));
                if (savedHistory) setHistory(JSON.parse(savedHistory));
                
                if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    setJudgeName(profile.name);
                    setAccessKey(profile.key);
                    setEditJudgeName(profile.name);
                    setEditAccessKey(profile.key);
                    setEventCity(profile.city || 'Москва');
                    setIsAuthenticated(true);
                }
            }, []);

            useEffect(() => {
                if (isAuthenticated) {
                    localStorage.setItem('judging_app_v5_data', JSON.stringify(allData));
                    localStorage.setItem('judging_app_v5_submitted', JSON.stringify(submittedDisciplines));
                    localStorage.setItem('judging_app_v5_history', JSON.stringify(history));
                }
            }, [allData, submittedDisciplines, history, isAuthenticated]);

            const showToast = (message) => {
                setToast(message);
                setTimeout(() => setToast(null), 2500);
            };
            //_________________________________________
          const handleAuth = async () => {
    // 1. Очищаем прошлые ошибки
    if (setAuthError) setAuthError(null); 

    try {
        // 2. Вызываем функцию из вашего assets/firebase-db.js
        // Передаем то, что ввел пользователь
        const result = await window.api.loginWithKey(tempJudgeName, accessKey);

        if (result.success) {
            // Если Firebase ответил успешно:
            // Берем имя из БД (если есть), иначе используем то, что ввел судья
            const finalName = result.user?.displayName || tempJudgeName || 'Судья';
            
            // 3. Обновляем визуальное состояние приложения
            setJudgeName(finalName);
            setEventCity(selectedCity);
            setIsAuthenticated(true);

            // 4. Сохраняем "бекап" устройства в localStorage
            const profileData = { 
                name: finalName, 
                key: accessKey, 
                city: selectedCity 
            };
            localStorage.setItem('judging_app_v5_profile', JSON.stringify(profileData));

            // Если у вас есть поля для настроек, обновляем их тоже
            if (setEditJudgeName) setEditJudgeName(finalName);
            if (setEditAccessKey) setEditAccessKey(accessKey);
            
            console.log("Успешный вход!");
        } else {
            // Если Firebase вернул {success: false}
            if (setAuthError) setAuthError(result.error || 'Неверный ключ доступа');
        }
    } catch (err) {
        // Если вообще пропал интернет или ошибка в коде
        if (setAuthError) setAuthError('Ошибка сети: проверьте подключение');
        console.error("Ошибка при логине:", err);
    }
};
//__________________________________________
            const handleSaveSettings = () => {
                setJudgeName(editJudgeName);
                setAccessKey(editAccessKey);
                localStorage.setItem('judging_app_v5_profile', JSON.stringify({ name: editJudgeName, key: editAccessKey, city: eventCity }));
                setIsSettingsOpen(false);
                showToast('Настройки сохранены');
            };

            const participants = allData[discipline] || [{ id: '1', number: '00', comment: '', photos: [], score: null }];
            const isCurrentSubmitted = submittedDisciplines.includes(discipline);
            
            const availableScores = Array.from({ length: participants.length }, (_, i) => 30 - i);
            const occupiedScores = participants.map(p => p.score).filter(s => s !== null);
            const allOccupiedNumbers = Object.values(allData).flat().map(p => p.number);

            const setParticipants = (newParticipants) => {
                if (isCurrentSubmitted) return;
                const updater = typeof newParticipants === 'function' ? newParticipants(participants) : newParticipants;
                
                const nextParticipants = updater.map(p => {
                    const newMaxLen = updater.length;
                    const lowestAllowed = 30 - (newMaxLen - 1);
                    if (p.score !== null && p.score < lowestAllowed) {
                        return { ...p, score: null };
                    }
                    return p;
                });
                setAllData(prev => ({ ...prev, [discipline]: nextParticipants }));
            };

            // Новая функция отправки (внутри App)
            const sendEvaluation = async (evalData) => {
                const profile = JSON.parse(localStorage.getItem('judging_app_v5_profile') || '{}');
                const fullData = {
                    ...evalData,
                    accessKey: profile.key || '',
                    deviceId: window.deviceId || 'unknown'
                };
                try {
                    await window.api.saveEvaluation(fullData);
                    console.log("Данные успешно отправлены в Firebase");
                } catch (e) {
                    console.error("Ошибка при отправке в Firebase:", e);
                    showToast("Ошибка: данные не ушли на сервер");
                }
            };

            // Обновленный обработчик нажатия кнопки
            const handleSendReport = async () => {
                if (submittedDisciplines.includes(discipline)) return;

                // 1. Отправляем в базу данных
                await sendEvaluation({
                    discipline: discipline,
                    participants: participants,
                    timestamp: new Date().toISOString()
                });

                // 2. Обновляем локальный статус (то, что было у тебя)
                const now = new Date();
                const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                
                const newHistoryEntries = participants.map(p => ({
                    date: timestamp,
                    discipline: discipline,
                    participantId: p.number,
                    score: p.score
                }));
                
                setHistory(prev => [...newHistoryEntries, ...prev]);
                setSubmittedDisciplines(prev => [...prev, discipline]);
                showToast('Отчет успешно отправлен');
            };


            const startCamera = async (id) => {
                if (isCurrentSubmitted) return;
                setActiveCamera(id);
                try {
                    if (stream) stream.getTracks().forEach(track => track.stop());
                    const constraints = {
                        video: { 
                            facingMode: { ideal: facingMode }, 
                            width: { ideal: 1920 }, // Просим высокое разрешение
                            height: { ideal: 1080 } 
                        },
                        audio: false
                    };
                    const mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    setStream(mediaStream);
                    setTimeout(() => {
                        if (videoRef.current) {
                            videoRef.current.srcObject = mediaStream;
                        }
                    }, 100);
                } catch (err) { 
                    setActiveCamera(null);
                    showToast('Ошибка доступа к камере');
                }
            };

            // Исправленная функция захвата фото с коррекцией ориентации и кадрированием
            const takePhoto = () => {
                if (!videoRef.current || isCurrentSubmitted) return;
                
                const video = videoRef.current;
                const canvas = document.createElement('canvas');
                
                // Получаем реальные размеры видеопотока
                const vWidth = video.videoWidth;
                const vHeight = video.videoHeight;
                
                // Целевые пропорции (вертикальные, как экран телефона)
                const targetWidth = 1080;
                const targetHeight = 1920;
                const targetRatio = targetWidth / targetHeight;

                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');

                // Расчет области обрезки (Crop), чтобы имитировать object-cover
                let sourceX, sourceY, sourceWidth, sourceHeight;
                const videoRatio = vWidth / vHeight;

                if (videoRatio > targetRatio) {
                    // Видео шире чем нужно (горизонтальное) -> режем по бокам
                    sourceHeight = vHeight;
                    sourceWidth = vHeight * targetRatio;
                    sourceX = (vWidth - sourceWidth) / 2;
                    sourceY = 0;
                } else {
                    // Видео уже чем нужно (вертикальное, но других пропорций) -> режем сверху/снизу
                    sourceWidth = vWidth;
                    sourceHeight = vWidth / targetRatio;
                    sourceX = 0;
                    sourceY = (vHeight - sourceHeight) / 2;
                }

                // Отражение для фронтальной камеры
                if (facingMode === 'user') {
                    ctx.translate(canvas.width, 0);
                    ctx.scale(-1, 1);
                }

                // Рисуем обрезанную и масштабированную часть видео
                ctx.drawImage(
                    video, 
                    sourceX, sourceY, sourceWidth, sourceHeight, // Откуда берем
                    0, 0, targetWidth, targetHeight             // Куда рисуем
                );

                const photoUrl = canvas.toDataURL('image/jpeg', 0.85);
                setParticipants(prev => prev.map(p => p.id === activeCamera ? { ...p, photos: [...p.photos, photoUrl] } : p));
                stopCamera();
            };

            const stopCamera = () => {
                if (stream) stream.getTracks().forEach(track => track.stop());
                setStream(null);
                setActiveCamera(null);
            };

            const toggleFacingMode = () => {
                setFacingMode(prev => prev === 'user' ? 'environment' : 'user');
                stopCamera();
            };

            const updateParticipant = (id, field, value) => {
                if (isCurrentSubmitted) return;
                if (field === 'score' && value !== null && occupiedScores.includes(value)) {
                    showToast('Оценка уже занята'); return;
                }
                if (field === 'number' && value !== '00' && allOccupiedNumbers.includes(value)) {
                    showToast('ID уже используется'); return;
                }
                setParticipants(participants.map(p => p.id === id ? { ...p, [field]: value } : p));
                setOpenSelect({ id: null, type: null });
            };

            const isReadyToSave = participants.length > 0 && participants.every(p => p.score !== null && p.number !== '00');

            if (loading) return <Preloader onComplete={() => setLoading(false)} />;

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-white flex flex-col items-center justify-center px-8">
                        <div className="w-full max-w-sm space-y-10">
                            <div className="text-center space-y-2">
                                <h1 className="text-2xl font-light tracking-tight text-black">Авторизация</h1>
                                <p className="text-[10px] text-gray-400 font-medium uppercase tracking-[0.3em]">Судейская панель АПБ</p>
                            </div>
                            <div className="space-y-6">
                                {authStep === 1 ? (
                                    <div className="space-y-5">
                                        <div className="space-y-4">
                                            <div className="relative">
                                                <Icon name="person" className="absolute left-0 top-1/2 -translate-y-1/2 text-gray-300" size={20} />
                                                <input type="text" placeholder="Имя судьи" value={tempJudgeName} onChange={(e) => setTempJudgeName(e.target.value)} className="w-full bg-transparent border-b border-gray-100 py-3 pl-8 text-base font-light outline-none focus:border-black transition-colors" />
                                            </div>
                                            <div className="relative">
                                                <Icon name="location_on" className="absolute left-0 top-1/2 -translate-y-1/2 text-gray-300" size={20} />
                                                <button onClick={() => setIsCityOpen(!isCityOpen)} className="w-full bg-transparent border-b border-gray-100 py-3 pl-8 text-base text-left font-light outline-none flex justify-between items-center">
                                                    <span>{selectedCity}</span>
                                                    <Icon name="expand_more" className={`text-gray-300 transition-transform ${isCityOpen ? 'rotate-180' : ''}`} size={18} />
                                                </button>
                                                {isCityOpen && (
                                                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 shadow-xl rounded-xl py-1 z-50 overflow-hidden">
                                                        {cities.map(c => (
                                                            <button key={c} onClick={() => { setSelectedCity(c); setIsCityOpen(false); }} className="w-full px-5 py-3 text-left hover:bg-gray-50 text-sm font-light transition-colors">{c}</button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <button onClick={() => setAuthStep(2)} disabled={!tempJudgeName} className="w-full bg-[#3171af] text-white rounded-full py-4 text-[12px] font-medium uppercase tracking-widest active:scale-95 transition-all disabled:opacity-20">Далее</button>
                                    </div>
                                ) : (
                                    <div className="space-y-5">
                                        <div className="relative">
                                            <Icon name="lock" className="absolute left-0 top-1/2 -translate-y-1/2 text-gray-300" size={20} />
                                            <input type="password" placeholder="Ключ доступа" autoFocus value={accessKey} onChange={(e) => setAccessKey(e.target.value)} className="w-full bg-transparent border-b border-gray-100 py-3 pl-8 text-base font-light tracking-widest outline-none focus:border-black" />
                                        </div>
                                        {authError && <p className="text-red-500 text-[9px] text-center uppercase font-medium">{authError}</p>}
                                        <div className="flex gap-2">
                                            <button onClick={() => setAuthStep(1)} className="w-14 h-14 rounded-full border border-gray-100 flex items-center justify-center text-gray-400 active:scale-90 transition-all"><Icon name="arrow_back" /></button>
                                            <button onClick={handleAuth} className="flex-1 bg-[#3171af] text-white rounded-full py-4 text-[12px] font-medium uppercase tracking-widest active:scale-95 transition-all">Войти</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-44 relative bg-[#F8F8F8]">
                    {toast && (
                        <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[250] bg-black text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-in fade-in slide-in-from-top-4">
                            <Icon name="info" size={18} className="text-yellow-400" />
                            <span className="text-[11px] font-medium uppercase tracking-wider">{toast}</span>
                        </div>
                    )}
                    
                    <nav className="sticky top-0 z-[60] glass border-b border-gray-100 h-16">
                        <div className="max-w-md mx-auto px-6 h-full flex items-center justify-between">
                            <div className="flex flex-col">
                                <span className="text-[8px] font-medium text-gray-400 uppercase tracking-widest">Судья/Город</span>
                                <div className="flex items-center gap-1.5">
                                    <span className="text-[13px] font-medium uppercase tracking-tight">{judgeName}</span>
                                    <span className="text-gray-300 font-thin">•</span>
                                    <span className="text-[13px] font-light text-gray-400 uppercase">{eventCity}</span>
                                </div>
                            </div>
                            <div className="relative">
                                <button onClick={() => setIsDisciplineOpen(!isDisciplineOpen)} className="flex flex-col items-end">
                                    <span className="text-[8px] font-medium text-gray-400 uppercase tracking-widest">Наминация</span>
                                    <div className="flex items-center gap-1">
                                        <span className="text-[13px] font-medium uppercase">{discipline}</span>
                                        <Icon name="expand_more" className={`text-gray-400 transition-transform ${isDisciplineOpen ? 'rotate-180' : ''}`} size={16} />
                                    </div>
                                </button>
                                {isDisciplineOpen && (
    /* Добавлены: max-h-64 (высота), overflow-y-auto (прокрутка), no-scrollbar (скрыть полосу) */
    <div className="absolute top-full right-0 mt-2 bg-white border border-gray-100 shadow-2xl rounded-xl py-1 w-56 z-50 max-h-64 overflow-y-auto no-scrollbar">

                                        {disciplines.map(d => (
                                            <button key={d} onClick={() => { setDiscipline(d); setIsDisciplineOpen(false); }} className="w-full px-5 py-3 text-left hover:bg-gray-50 text-[12px] font-light flex justify-between items-center">
                                                {d} {submittedDisciplines.includes(d) && <Icon name="check_circle" className="text-green-500" size={14} />}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-md mx-auto px-6 pt-6 space-y-6">
                        {isCurrentSubmitted && (
                            <div className="bg-green-50 border border-green-100 rounded-xl p-3 flex items-center gap-3 text-green-700">
                                <Icon name="check_circle" size={18} />
                                <span className="text-[10px] font-medium uppercase tracking-wider">Отчет отправлен и заблокирован</span>
                            </div>
                        )}
                        
                        {participants.map((participant, index) => {
                            const isNumOpen = openSelect.id === participant.id && openSelect.type === 'number';
                            const isScoreOpen = openSelect.id === participant.id && openSelect.type === 'score';
                            return (
                                <div key={participant.id} className={`card-animate space-y-2 transition-opacity ${isCurrentSubmitted ? 'opacity-70' : ''}`}>
                                    <div className="flex items-center justify-between px-1">
                                        <span className="text-[9px] font-medium text-gray-400 uppercase tracking-widest">Участник {String(index + 1).padStart(2, '0')}</span>
                                        {!isCurrentSubmitted && participants.length > 1 && (
                                            <button onClick={() => setParticipants(participants.filter(p => p.id !== participant.id))} className="text-gray-300 hover:text-red-500 transition-colors"><Icon name="delete" size={16} /></button>
                                        )}
                                    </div>
                                    
                                    <div className="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm space-y-5">
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="relative">
                                                <label className="text-[8px] font-medium text-gray-400 uppercase tracking-[0.2em] mb-1.5 block">ID Номер</label>
                                                <button disabled={isCurrentSubmitted} onClick={() => setOpenSelect({ id: participant.id, type: isNumOpen ? null : 'number' })} className="w-full flex items-center justify-between border-b border-gray-50 pb-2 text-xl font-light outline-none">
                                                    {participant.number} {!isCurrentSubmitted && <Icon name="expand_more" className="text-gray-200" size={18} />}
                                                </button>
                                                {isNumOpen && (
                                                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 z-[80] h-44 overflow-y-auto no-scrollbar shadow-xl rounded-xl">
                                                        {participantNumbers.map(n => {
                                                            const isOcc = allOccupiedNumbers.includes(n) && n !== participant.number && n !== '00';
                                                            return <div key={n} onClick={() => !isOcc && updateParticipant(participant.id, 'number', n)} className={`py-3 px-4 font-light border-b border-gray-50 text-sm ${isOcc ? 'text-red-200 bg-red-50/20' : 'hover:bg-gray-50'}`}>{n} {isOcc && '✖'}</div>
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="relative">
                                                <label className="text-[8px] font-medium text-gray-400 uppercase tracking-[0.2em] mb-1.5 block">Баллы</label>
                                                <button disabled={isCurrentSubmitted} onClick={() => setOpenSelect({ id: participant.id, type: isScoreOpen ? null : 'score' })} className={`w-full flex items-center justify-between border-b pb-2 text-xl font-light outline-none ${participant.score !== null ? 'border-black text-black' : 'border-gray-50 text-gray-200'}`}>
                                                    {participant.score !== null ? participant.score : '--'} {!isCurrentSubmitted && <Icon name="expand_more" className="opacity-20" size={18} />}
                                                </button>
                                                {isScoreOpen && (
                                                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 z-[80] h-44 overflow-y-auto no-scrollbar shadow-xl rounded-xl">
                                                        <div onClick={() => updateParticipant(participant.id, 'score', null)} className="py-3 px-4 text-[9px] text-gray-400 font-medium border-b border-gray-50 uppercase tracking-widest cursor-pointer">Сброс</div>
                                                        {availableScores.map(s => {
                                                            const isOcc = occupiedScores.includes(s) && s !== participant.score;
                                                            return <div key={s} onClick={() => !isOcc && updateParticipant(participant.id, 'score', s)} className={`py-3 px-4 font-light border-b border-gray-50 text-sm ${isOcc ? 'text-red-200 bg-red-50/20' : 'hover:bg-gray-50'}`}>{s} {isOcc && '✖'}</div>
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="space-y-1.5">
                                            <label className="text-[8px] font-medium text-gray-400 uppercase tracking-[0.2em] block">Комментарий</label>
                                            <div onClick={() => !isCurrentSubmitted && setFullscreenNote({ id: participant.id, text: participant.comment })} className="min-h-[36px] text-[13px] text-gray-500 font-light leading-snug border-b border-gray-50 pb-2 cursor-pointer transition-colors">
                                                {participant.comment || "Нажмите для ввода заметки..."}
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-6 pt-1">
                                            <button onClick={() => startCamera(participant.id)} disabled={isCurrentSubmitted} className="flex items-center gap-2 text-gray-600 text-[10px] font-medium uppercase tracking-widest disabled:opacity-20">
                                                <Icon name="photo_camera" size={18} /> Фото
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                                                    if (!SpeechRecognition) return showToast('Голосовой ввод не поддерживается');
                                                    const r = new SpeechRecognition();
                                                    r.lang = 'ru-RU';
                                                    r.onstart = () => setIsRecording(participant.id);
                                                    r.onend = () => setIsRecording(null);
                                                    r.onresult = (e) => updateParticipant(participant.id, 'comment', (participant.comment ? participant.comment + ' ' : '') + e.results[0][0].transcript);
                                                    r.start();
                                                }} 
                                                disabled={isCurrentSubmitted} 
                                                className={`flex items-center gap-2 text-[10px] font-medium uppercase tracking-widest transition-colors disabled:opacity-20 ${isRecording === participant.id ? 'text-red-600 animate-pulse' : 'text-gray-600'}`}
                                            >
                                                <Icon name="mic" size={18} /> Голос
                                            </button>
                                            <label className="flex items-center gap-2 text-gray-600 text-[10px] font-medium uppercase tracking-widest cursor-pointer disabled:opacity-20">
                                                <Icon name="attach_file" size={18} /> Файл
                                                <input type="file" multiple accept="image/*" className="hidden" disabled={isCurrentSubmitted} onChange={(e) => {
                                                    const files = Array.from(e.target.files);
                                                    files.forEach(f => {
                                                        const reader = new FileReader();
                                                        reader.onload = (re) => updateParticipant(participant.id, 'photos', [...participant.photos, re.target.result]);
                                                        reader.readAsDataURL(f);
                                                    });
                                                }} />
                                            </label>
                                        </div>

                                        {participant.photos.length > 0 && (
                                            <div className="flex gap-2 overflow-x-auto no-scrollbar pt-1">
                                                {participant.photos.map((p, i) => <img key={i} src={p} className="w-12 h-12 rounded-lg object-cover border border-gray-50 flex-shrink-0" alt="" />)}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </main>

                    <footer className="fixed bottom-0 left-0 right-0 glass border-t border-gray-100 px-6 py-4 pb-8 z-40">
                        <div className="max-w-md mx-auto">
                            <div className="flex gap-1.5 mb-4 overflow-x-auto no-scrollbar py-1 pl-2">
                                {availableScores.map(s => {
                                    const used = occupiedScores.includes(s);
                                    return (
                                        <div key={s} className={`flex-shrink-0 w-6 h-6 flex items-center justify-center text-[9px] rounded-full border transition-all duration-300 ${used ? 'bg-[#3171af] border-[#3171af] text-white scale-[1.1]' : 'bg-transparent border-gray-200 text-gray-300'}`}>
                                            <span>{s}</span>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            <div className="flex gap-3">
                                <button disabled={isCurrentSubmitted} onClick={() => setParticipants([...participants, { id: Date.now().toString(), number: '00', comment: '', photos: [], score: null }])} className={`w-11 h-11 rounded-full border border-gray-100 flex items-center justify-center active:scale-90 transition-all shadow-sm ${isCurrentSubmitted ? 'opacity-10' : 'bg-white'}`}>
                                    <Icon name="add" size={24} />
                                </button>
                                <button onClick={handleSendReport} disabled={!isReadyToSave || isCurrentSubmitted} className={`flex-1 h-11 rounded-full flex items-center justify-center gap-3 font-medium text-[10px] uppercase tracking-[0.2em] transition-all ${isReadyToSave && !isCurrentSubmitted ? 'bg-[#3171af] text-white shadow-lg active:scale-95' : 'bg-gray-100 text-gray-300 pointer-events-none'}`}>
                                    <Icon name="send" size={16} /> {isCurrentSubmitted ? 'Отправлено' : 'Отправить отчет'}
                                </button>
                                <button onClick={() => setIsSettingsOpen(true)} className="w-11 h-11 rounded-full border border-gray-100 bg-white flex items-center justify-center active:scale-90 transition-all shadow-sm">
                                    <Icon name="settings" size={24} className="text-gray-600" />
                                </button>
                            </div>
                        </div>
                    </footer>

                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-white/60 backdrop-blur-xl z-[150] flex flex-col items-center justify-center p-8">
                            <div className="w-full max-w-sm bg-white rounded-[32px] p-8 shadow-2xl space-y-8 border border-gray-100 card-animate">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-light tracking-tight">Настройки</h2>
                                    <button onClick={() => setIsSettingsOpen(false)} className="text-gray-400"><Icon name="close" /></button>
                                </div>
                                <div className="space-y-6">
                                    <div className="space-y-1.5">
                                        <label className="text-[8px] font-medium text-gray-400 uppercase tracking-widest block">Логин (Имя)</label>
                                        <input type="text" value={editJudgeName} onChange={(e) => setEditJudgeName(e.target.value)} className="w-full bg-gray-50 border-none rounded-2xl py-4 px-5 text-sm outline-none focus:ring-1 focus:ring-black transition-all" />
                                    </div>
                                    <div className="space-y-1.5">
                                        <label className="text-[8px] font-medium text-gray-400 uppercase tracking-widest block">Пароль (Ключ)</label>
                                        <input type="text" value={editAccessKey} onChange={(e) => setEditAccessKey(e.target.value)} className="w-full bg-gray-50 border-none rounded-2xl py-4 px-5 text-sm outline-none focus:ring-1 focus:ring-black transition-all" />
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <button onClick={handleSaveSettings} className="w-full bg-[#3171af] text-white rounded-full py-4 text-[11px] font-medium uppercase tracking-widest active:scale-95 transition-all">Сохранить</button>
                                    <button onClick={() => setIsHistoryOpen(true)} className="w-full bg-gray-50 text-gray-600 rounded-full py-4 text-[11px] font-medium uppercase tracking-widest active:scale-95 transition-all">История оценок</button>
                                    <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="w-full bg-red-50 text-red-500 rounded-full py-4 text-[11px] font-medium uppercase tracking-widest active:scale-95 transition-all">Выйти</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isHistoryOpen && (
                        <div className="fixed inset-0 bg-white z-[160] flex flex-col p-8">
                            <div className="flex justify-between items-center mb-8">
                                <button onClick={() => setIsHistoryOpen(false)} className="flex items-center gap-2 text-gray-400 text-[11px] font-medium uppercase tracking-widest">
                                    <Icon name="arrow_back" size={18} /> Назад
                                </button>
                                <span className="text-[9px] font-medium text-gray-300 uppercase tracking-[0.3em]">История</span>
                            </div>
                            <div className="flex-1 overflow-y-auto no-scrollbar rounded-2xl border border-gray-100">
                                {history.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 space-y-4">
                                        <Icon name="history" size={48} className="opacity-20" />
                                        <p className="text-[10px] uppercase tracking-widest">История пуста</p>
                                    </div>
                                ) : (
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-gray-50 border-b border-gray-100">
                                            <tr>
                                                <th className="px-4 py-3 text-[9px] font-semibold text-gray-400 uppercase tracking-wider">ID</th>
                                                <th className="px-4 py-3 text-[9px] font-semibold text-gray-400 uppercase tracking-wider text-right">Балл</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-50">
                                            {history.map((item, idx) => (
                                                <tr key={idx} className="hover:bg-gray-50">
                                                    <td className="px-4 py-4">
                                                        <div className="text-[13px] font-medium">#{item.participantId}</div>
                                                        <div className="text-[8px] text-gray-400 uppercase">{item.discipline}</div>
                                                    </td>
                                                    <td className="px-4 py-4 text-right">
                                                        <span className="bg-black text-white text-[10px] px-2 py-0.5 rounded font-medium">{item.score}</span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    )}

                    {fullscreenNote && (
                        <div className="fixed inset-0 bg-white z-[200] flex flex-col p-8 animate-in fade-in slide-in-from-bottom-5 duration-300">
                            <div className="flex justify-between items-center mb-10">
                                <span className="text-[9px] font-medium text-gray-400 uppercase tracking-[0.3em]">Заметка</span>
                                <button onClick={() => { updateParticipant(fullscreenNote.id, 'comment', fullscreenNote.text); setFullscreenNote(null); }} className="text-black font-medium text-[13px] uppercase tracking-wider border-b border-black">Готово</button>
                            </div>
                            <textarea autoFocus value={fullscreenNote.text} onChange={(e) => setFullscreenNote({...fullscreenNote, text: e.target.value})} className="flex-1 text-2xl font-light outline-none bg-transparent resize-none leading-relaxed" placeholder="Опишите нюансы..." />
                        </div>
                    )}

                    {activeCamera && (
                        <div className="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center">
                            <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
                            <div className="absolute top-0 left-0 right-0 p-6 flex justify-between items-center bg-gradient-to-b from-black/60 to-transparent">
                                <button onClick={stopCamera} className="text-white bg-white/10 backdrop-blur-md p-3 rounded-full border border-white/10">
                                    <Icon name="close" size={28} />
                                </button>
                                <button onClick={toggleFacingMode} className="text-white bg-white/10 backdrop-blur-md p-3 rounded-full border border-white/10">
                                    <Icon name="flip_camera_ios" size={28} />
                                </button>
                            </div>
                            <div className="absolute bottom-0 left-0 right-0 p-10 pb-20 flex justify-center items-center bg-gradient-to-t from-black/60 to-transparent">
                                <button onClick={takePhoto} className="w-20 h-20 bg-[#3171af] rounded-full border-[6px] border-white/20 flex items-center justify-center active:scale-90 transition-transform">
                                    <div className="w-14 h-14 bg-white rounded-full border-2 border-black/5" />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
